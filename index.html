<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador Masivo Carrefour</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root { --azul: #0B3A8F; }
        body { font-family: 'Ubuntu', sans-serif; background: #222; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; color: white; }
        
        .container { display: flex; gap: 20px; width: 100%; max-width: 1200px; align-items: flex-start; }
        
        /* PANEL DE CONTROL */
        .controls { background: #333; padding: 20px; border-radius: 10px; flex: 1; border: 1px solid #444; }
        h2 { margin-top: 0; border-bottom: 1px solid #555; padding-bottom: 10px; }
        label { display: block; font-weight: bold; margin: 15px 0 5px; color: #ddd; }
        input[type="file"] { background: #222; padding: 10px; width: 100%; border: 1px solid #555; border-radius: 5px; }
        
        .log-area { 
            background: #111; color: #0f0; font-family: monospace; 
            padding: 10px; height: 150px; overflow-y: auto; 
            margin-top: 20px; border-radius: 5px; font-size: 12px;
        }

        .btn-action {
            background: #28a745; color: white; font-size: 16px; width: 100%; 
            padding: 15px; border: none; border-radius: 8px; cursor: pointer; margin-top: 20px; font-weight: bold;
        }
        .btn-action:disabled { background: #555; cursor: not-allowed; }

        /* ZONA DE DIBUJO (Oculta visualmente pero activa) */
        .canvas-wrapper {
            /* Lo dejamos visible peque√±o para debugar, pero no molesta */
            transform: scale(0.4); transform-origin: top left;
            border: 2px solid #555;
            width: 1000px; height: 1000px;
            position: fixed; top: 0; left: -9999px; /* Fuera de pantalla para proceso masivo */
        }

        .canvas-container {
            position: relative; width: 1000px; height: 1000px;
            background-color: #fff;
            background-size: cover; background-position: center; background-repeat: no-repeat;
            overflow: hidden;
        }

        /* CAPAS */
        .layer { position: absolute; pointer-events: none; }
        #layer-footer { width: 1000px; height: 167px; bottom: 0; left: 0; z-index: 10; }
        #layer-badge { width: 187px; height: 155px; top: 30px; left: 30px; z-index: 20; }
        .title-pill {
            position: absolute; top: 70px; left: 200px; height: 70px;
            background: rgba(255,255,255, 0.95); border-radius: 0 50px 50px 0; 
            z-index: 15; width: auto; min-width: 300px; 
        }
        #txt-title {
            position: absolute; top: 75px; left: 230px; color: var(--azul); 
            font-size: 50px; line-height: 1; z-index: 30; white-space: nowrap;
        }
        .weight-box {
            position: absolute; bottom: 0; right: 0; width: 215px; height: 167px; z-index: 30;
            display: flex; justify-content: center; align-items: center;
        }
        #txt-weight { color: white; font-size: 55px; line-height: 1; margin-bottom: 10px; white-space: nowrap; }

    </style>
</head>
<body>

    <div class="container">
        <div class="controls">
            <h2>üè≠ Generador Masivo (CSV)</h2>
            <p style="color:#aaa; font-size:0.9em;">Sube tu CSV con columnas: <b>nombre_producto, categoria, imagen_url, coccion, unidad</b></p>
            
            <label>1. Archivo CSV</label>
            <input type="file" id="csv-file" accept=".csv">

            <button id="btn-process" class="btn-action" onclick="startBatch()">üöÄ PROCESAR LOTE</button>

            <div class="log-area" id="console-log">Esperando archivo...</div>
        </div>
    </div>

    <div class="canvas-wrapper">
        <div class="canvas-container" id="capture-area">
            <img id="layer-footer" class="layer" src="footer_full.png">
            <div id="bg-pill" class="title-pill"></div>
            <img id="layer-badge" class="layer" src="badge_vaca.png">
            <div id="txt-title">Titulo</div>
            <div class="weight-box"><div id="txt-weight">1kg</div></div>
        </div>
    </div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        const logArea = document.getElementById('console-log');
        
        function log(msg) {
            logArea.innerHTML += `> ${msg}<br>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // --- MAPEO INTELIGENTE ---
        // Convierte lo que escribes en Excel a nombres de archivo reales
        function getBadgeFile(category) {
            const cat = category.toLowerCase().trim();
            if (cat.includes('vaca') || cat.includes('novillo') || cat.includes('carne')) return 'badge_vaca.png';
            if (cat.includes('cerdo') || cat.includes('puerco')) return 'badge_cerdo.png';
            if (cat.includes('pollo') || cat.includes('ave')) return 'badge_pollo.png';
            if (cat.includes('pescado') || cat.includes('mar')) return 'badge_pescado.png';
            return 'badge_vaca.png'; // Default
        }

        function getFooterFile(cooking) {
            const c = cooking.toLowerCase();
            const hasParrilla = c.includes('parrilla');
            const hasHorno = c.includes('horno');
            const hasOlla = c.includes('olla');

            // Prioridad a combinaciones
            if (hasParrilla && hasHorno && hasOlla) return 'footer_full.png';
            if (hasParrilla && hasHorno) return 'footer_parrilla_horno.png';
            if (hasParrilla && hasOlla) return 'footer_parrilla_olla.png';
            if (hasHorno && hasOlla) return 'footer_horno_olla.png';
            
            // Simples
            if (hasParrilla) return 'footer_parrilla.png';
            if (hasHorno) return 'footer_horno.png';
            if (hasOlla) return 'footer_olla.png';
            
            return 'footer_full.png'; // Default
        }

        // --- PROCESO MASIVO ---
        async function startBatch() {
            const fileInput = document.getElementById('csv-file');
            if (!fileInput.files.length) { alert('Sube un CSV primero'); return; }

            const btn = document.getElementById('btn-process');
            btn.disabled = true;
            btn.innerText = '‚è≥ Procesando...';
            log('Iniciando lectura de CSV...');

            Papa.parse(fileInput.files[0], {
                header: true,
                skipEmptyLines: true,
                complete: async function(results) {
                    const rows = results.data;
                    log(`Detectadas ${rows.length} filas.`);
                    
                    const zip = new JSZip();
                    const folder = zip.folder("ofertas-carrefour");

                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        if(!row.nombre_producto) continue; // Saltar filas vac√≠as

                        log(`Generando ${i+1}/${rows.length}: ${row.nombre_producto}`);
                        
                        try {
                            // 1. Configurar el Canvas con datos de la fila
                            await setupCanvas(row);
                            
                            // 2. Generar Blob
                            const blob = await generateImage();
                            
                            // 3. A√±adir al ZIP
                            // Limpiamos nombre de archivo
                            const safeName = row.nombre_producto.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                            folder.file(`${safeName}.webp`, blob);
                            
                        } catch (err) {
                            log(`‚ùå Error en fila ${i+1}: ${err.message}`);
                        }
                    }

                    log('üì¶ Comprimiendo ZIP final...');
                    const content = await zip.generateAsync({type:"blob"});
                    saveAs(content, "ofertas-batch.zip");
                    
                    log('‚úÖ ¬°Listo! Descarga iniciada.');
                    btn.disabled = false;
                    btn.innerText = 'üöÄ PROCESAR LOTE';
                }
            });
        }

        // Configura el DOM para una fila espec√≠fica
        function setupCanvas(row) {
            return new Promise((resolve, reject) => {
                const area = document.getElementById('capture-area');
                
                // Textos
                document.getElementById('txt-title').innerText = row.nombre_producto;
                document.getElementById('txt-weight').innerText = row.unidad;
                
                // Pastilla T√≠tulo (Ancho din√°mico)
                const width = (row.nombre_producto.length * 28) + 60; 
                document.getElementById('bg-pill').style.width = width + 'px';

                // Im√°genes Assets
                document.getElementById('layer-badge').src = getBadgeFile(row.categoria || '');
                document.getElementById('layer-footer').src = getFooterFile(row.coccion || '');

                // Cargar imagen de fondo (CORS handling)
                const imgUrl = row.imagen_url;
                
                // Creamos una imagen temporal para asegurar que carg√≥ antes de capturar
                const tempImg = new Image();
                tempImg.crossOrigin = "Anonymous"; // CR√çTICO para VTEX
                tempImg.onload = () => {
                    area.style.backgroundImage = `url('${imgUrl}')`;
                    resolve();
                };
                tempImg.onerror = () => {
                    log(`‚ö†Ô∏è No se pudo cargar imagen: ${imgUrl}`);
                    // Ponemos un placeholder o seguimos igual
                    area.style.background = '#ccc';
                    resolve(); 
                };
                tempImg.src = imgUrl; 
            });
        }

        // Captura el estado actual del DOM
        function generateImage() {
            return new Promise((resolve, reject) => {
                const area = document.getElementById('capture-area');
                html2canvas(area, {
                    scale: 1,
                    useCORS: true, // Vital para im√°genes externas
                    allowTaint: true,
                    backgroundColor: null,
                    logging: false,
                    onclone: (doc) => {
                        doc.getElementById('capture-area').style.fontFeatureSettings = '"liga" 0';
                    }
                }).then(canvas => {
                    canvas.toBlob(resolve, 'image/webp', 0.92);
                }).catch(reject);
            });
        }

    </script>
</body>
</html>
