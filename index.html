<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador Carrefour MASSIVE FIX</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* ESTILOS DE INTERFAZ */
        :root { --azul-carrefour: #0B3A8F; }
        
        body { 
            font-family: 'Ubuntu', sans-serif; background: #121212; margin: 0; padding: 40px; 
            display: flex; flex-direction: column; align-items: center; color: white; 
        }
        
        .panel-control { 
            background: #1e1e1e; padding: 40px; border-radius: 16px; 
            width: 100%; max-width: 700px; border: 1px solid #333; 
        }
        
        h1 { margin: 0 0 10px 0; color: #fff; font-size: 26px; }
        .subtitle { color: #ffc107; margin-bottom: 30px; font-weight: bold; font-size: 14px; letter-spacing: 1px; text-transform: uppercase; }
        
        .input-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 10px; color: #ddd; }
        input[type="file"] { 
            background: #252525; padding: 20px; width: 100%; 
            border: 2px dashed #444; border-radius: 8px; color: #fff; box-sizing: border-box;
        }
        
        .btn-download {
            background: var(--azul-carrefour); color: white; font-size: 18px; width: 100%; 
            padding: 20px; border: none; border-radius: 10px; cursor: pointer; 
            margin-top: 20px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
            transition: all 0.2s;
        }
        .btn-download:hover { background: #154bb5; transform: translateY(-2px); }
        .btn-download:disabled { background: #333; opacity: 0.7; cursor: not-allowed; transform: none; }

        .console-log { 
            background: #000; color: #00ff00; font-family: 'Consolas', monospace; 
            padding: 20px; height: 200px; overflow-y: auto; margin-top: 30px; 
            border-radius: 8px; font-size: 12px; border: 1px solid #333;
        }

        /* --- F√ÅBRICA FANTASMA --- */
        #shadow-factory {
            position: fixed; top: 0; left: -10000px; 
            width: 1000px; height: 1000px;
            background-color: #ffffff; z-index: -9999;
        }

        /* LIENZO DE RENDERIZADO */
        .canvas-container {
            position: relative; width: 1000px; height: 1000px; overflow: hidden;
            image-rendering: high-quality; -webkit-font-smoothing: antialiased;
        }

        /* FONDO */
        .bg-layer {
            position: absolute; top: 0; left: 0; width: 1000px; height: 1000px;
            background-size: cover; background-position: center; background-repeat: no-repeat;
            z-index: 1;
        }

        /* CAPAS PNG */
        .layer-png { position: absolute; pointer-events: none; image-rendering: high-quality; }
        #layer-footer { width: 1000px; height: 167px; bottom: 0; left: 0; z-index: 10; }
        #layer-badge { width: 187px; height: 155px; top: 30px; left: 30px; z-index: 30; }

        /* --- T√çTULO (FLEXBOX CORREGIDO) --- */
        .title-container {
            position: absolute; top: 70px; left: 180px; z-index: 20; 
            /* Flexbox para centrado perfecto */
            display: inline-flex; align-items: center; justify-content: flex-start;
            height: 75px; min-width: 100px;
            background: #ffffff; 
            border-radius: 0 50px 50px 0; 
            /* Padding ajustado y box-sizing para que no se desfase */
            padding-left: 60px; padding-right: 40px; 
            box-sizing: border-box; 
            box-shadow: none; border: none;
        }

        #txt-title {
            color: var(--azul-carrefour); 
            font-family: 'Ubuntu', sans-serif; font-weight: 700; font-size: 50px; 
            line-height: 1; white-space: nowrap; margin: 0; 
            /* Eliminado padding inferior manual que causaba desfasaje */
        }

        /* PESO */
        #txt-weight {
            position: absolute; bottom: 50px; right: 0; width: 215px; text-align: center; 
            color: #FFFFFF; font-family: 'Ubuntu', sans-serif; font-weight: 700; font-size: 55px; 
            line-height: 1; z-index: 40; white-space: nowrap;
        }
    </style>
</head>
<body>

    <div class="panel-control">
        <h1>üè≠ Generador Carrefour</h1>
        <div class="subtitle">üõ†Ô∏è FIXES: UTF-8 + ALINEACI√ìN</div>
        
        <div class="input-group">
            <label>1. Subir Archivo CSV (UTF-8)</label>
            <input type="file" id="csv-file" accept=".csv">
        </div>

        <button id="btn-process" class="btn-download" onclick="startBatch()">üöÄ GENERAR IM√ÅGENES WEBP</button>

        <div class="console-log" id="console-log">Esperando archivo CSV...</div>
    </div>

    <div id="shadow-factory">
        <div class="canvas-container" id="capture-area">
            <div id="bg-layer" class="bg-layer"></div>
            <img id="layer-footer" class="layer-png" src="footer_full.png">
            <img id="layer-badge" class="layer-png" src="badge_vaca.png">
            <div class="title-container">
                <span id="txt-title">CARGANDO...</span>
            </div>
            <div id="txt-weight">1.5 kg</div>
        </div>
    </div>

    <script>
        const logArea = document.getElementById('console-log');
        function log(msg) {
            logArea.innerHTML += `> ${msg}<br>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // --- ASSETS (CORREGIDO CON TUS CATEGOR√çAS EXACTAS) ---
        function getBadgeFile(category) {
            // Limpiamos el input (min√∫sculas y espacios extremos)
            const cat = (category || '').toLowerCase().trim();
            
            // Coincidencias exactas seg√∫n tu Excel
            if (cat === 'carne vacuna') return 'badge_vaca.png';
            if (cat === 'carne de cerdo') return 'badge_cerdo.png';
            if (cat === 'pollo y granja') return 'badge_pollo.png';
            if (cat === 'pescados y mariscos') return 'badge_pescado.png';

            // Fallbacks (por si acaso alguna viene diferente)
            if (cat.includes('vaca') || cat.includes('bovino')) return 'badge_vaca.png';
            if (cat.includes('cerdo') || cat.includes('puerco')) return 'badge_cerdo.png';
            if (cat.includes('pollo') || cat.includes('ave')) return 'badge_pollo.png';
            if (cat.includes('pesca') || cat.includes('mar')) return 'badge_pescado.png';
            
            return 'badge_vaca.png'; // Default
        }

        // La l√≥gica de cocci√≥n con comas YA FUNCIONA bien as√≠ (includes detecta la palabra igual)
        function getFooterFile(cooking) {
            const c = (cooking || '').toLowerCase();
            const hasParrilla = c.includes('parrilla');
            const hasHorno = c.includes('horno');
            const hasOlla = c.includes('olla');

            if (hasParrilla && hasHorno && hasOlla) return 'footer_full.png';
            if (hasParrilla && hasHorno) return 'footer_parrilla_horno.png';
            if (hasParrilla && hasOlla) return 'footer_parrilla_olla.png';
            if (hasHorno && hasOlla) return 'footer_horno_olla.png';
            if (hasParrilla) return 'footer_parrilla.png';
            if (hasHorno) return 'footer_horno.png';
            if (hasOlla) return 'footer_olla.png';
            return 'footer_full.png';
        }

        // --- SETUP ---
        function setupCanvas(row) {
            return new Promise((resolve, reject) => {
                document.getElementById('txt-title').innerText = (row.nombre_producto || 'PRODUCTO').trim();
                document.getElementById('txt-weight').innerText = (row.unidad || '').trim();

                document.getElementById('layer-badge').src = getBadgeFile(row.categoria);
                document.getElementById('layer-footer').src = getFooterFile(row.coccion);

                const imgUrl = row.imagen_url;
                const bgLayer = document.getElementById('bg-layer');
                bgLayer.style.backgroundImage = 'none';
                
                if (!imgUrl) { resolve(); return; }

                const tempImg = new Image();
                tempImg.crossOrigin = "Anonymous"; 
                
                tempImg.onload = () => {
                    bgLayer.style.backgroundImage = `url('${imgUrl}')`;
                    resolve();
                };
                
                tempImg.onerror = () => {
                    log(`‚ö†Ô∏è Error cargando imagen: ${imgUrl}`);
                    bgLayer.style.backgroundColor = '#333';
                    resolve();
                };
                // Timestamp para evitar cach√©
                tempImg.src = imgUrl + (imgUrl.includes('?') ? '&' : '?') + 'cb=' + new Date().getTime();
            });
        }

        // --- CAPTURA HD + WEBP ---
        function generateImage() {
            const area = document.getElementById('capture-area');
            return new Promise((resolve, reject) => {
                html2canvas(area, {
                    scale: 2, // Super-sampling para nitidez
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: null,
                    logging: false,
                    onclone: (clonedDoc) => {
                        const clonedArea = clonedDoc.getElementById('capture-area');
                        clonedArea.style.fontFeatureSettings = '"liga" 0';
                        clonedArea.style.imageRendering = 'high-quality'; 
                    }
                }).then(canvas => {
                    canvas.toBlob((blob) => {
                        if(blob) resolve(blob);
                        else reject(new Error("Canvas vac√≠o"));
                    }, 'image/webp', 0.95);
                }).catch(err => reject(err));
            });
        }

        // --- BATCH ---
        async function startBatch() {
            const fileInput = document.getElementById('csv-file');
            if (!fileInput.files.length) { alert('Falta el CSV'); return; }

            const btn = document.getElementById('btn-process');
            btn.disabled = true; btn.innerText = '‚è≥ PROCESANDO CON FIXES...';
            logArea.innerHTML = '';

            // FIX 1: FORZAR CODIFICACI√ìN UTF-8
            Papa.parse(fileInput.files[0], {
                header: true, 
                skipEmptyLines: true, 
                encoding: "UTF-8", // <--- ESTO ARREGLA LOS ACENTOS
                complete: async function(results) {
                    const rows = results.data;
                    const zip = new JSZip();
                    const folder = zip.folder("Carrefour_Fixed_WEBP");

                    await document.fonts.ready;
                    
                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        if (!row.nombre_producto) continue;
                        log(`üì∏ Procesando: ${row.nombre_producto}`);
                        
                        try {
                            await setupCanvas(row);
                            await new Promise(r => setTimeout(r, 100)); // Estabilizaci√≥n
                            const blob = await generateImage();
                            
                            const cleanName = row.nombre_producto.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                            folder.file(`${cleanName}.webp`, blob); 

                        } catch (error) { log(`‚ùå Error: ${error.message}`); }
                    }

                    log('üì¶ Comprimiendo ZIP...');
                    const content = await zip.generateAsync({type:"blob"});
                    saveAs(content, "Carrefour_Fixed_WEBP.zip");
                    
                    btn.disabled = false; btn.innerText = 'üöÄ GENERAR IM√ÅGENES WEBP';
                    log('‚úÖ ¬°TERMINADO!');
                }
            });
        }
    </script>
</body>
</html>
