<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador Carrefour FINAL ROBUSTO</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* --- ESTILOS VISUALES --- */
        :root { --azul-carrefour: #0B3A8F; }
        body { font-family: 'Ubuntu', sans-serif; background: #222; margin: 0; padding: 20px; color: white; display: flex; flex-direction: column; align-items: center; }
        
        .panel { background: #333; padding: 30px; border-radius: 12px; width: 100%; max-width: 800px; border: 1px solid #444; margin-bottom: 20px;}
        h1 { margin-top: 0; border-bottom: 2px solid var(--azul-carrefour); padding-bottom: 10px; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #ccc; }
        select, input { width: 100%; padding: 10px; background: #111; border: 1px solid #555; color: white; border-radius: 5px; }
        
        .console { background: #000; color: #0f0; font-family: monospace; padding: 15px; height: 200px; overflow-y: auto; border-radius: 5px; font-size: 12px; border: 1px solid #555; }
        
        .btn-main { background: var(--azul-carrefour); color: white; width: 100%; padding: 15px; font-size: 18px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; text-transform: uppercase; margin-top: 10px;}
        .btn-main:hover { background: #154bb5; }
        .btn-main:disabled { background: #555; cursor: not-allowed; }

        /* --- F√ÅBRICA FANTASMA (1000x1000) --- */
        #shadow-factory { position: fixed; top: 0; left: -10000px; width: 1000px; height: 1000px; background: #fff; z-index: -9999; }
        .canvas-container { position: relative; width: 1000px; height: 1000px; overflow: hidden; image-rendering: high-quality; }
        
        /* CAPAS */
        .bg-layer { position: absolute; top: 0; left: 0; width: 1000px; height: 1000px; background-size: cover; background-position: center; z-index: 1; }
        .layer-png { position: absolute; pointer-events: none; }
        #layer-footer { width: 1000px; height: 167px; bottom: 0; left: 0; z-index: 10; }
        #layer-badge { width: 187px; height: 155px; top: 30px; left: 30px; z-index: 30; }

        /* T√çTULO AUTO-AJUSTABLE */
        .title-pill {
            position: absolute; top: 70px; left: 180px; z-index: 20;
            display: inline-flex; align-items: center;
            height: 75px; 
            background: #fff; 
            border-radius: 0 50px 50px 0;
            padding-left: 60px; padding-right: 50px;
            max-width: 780px; /* L√≠mite para no salirse del canvas */
            box-sizing: border-box;
        }
        #txt-title {
            color: var(--azul-carrefour); font-weight: 700; font-size: 50px; line-height: 1; 
            white-space: nowrap; margin: 0;
        }

        /* PESO */
        #txt-weight {
            position: absolute; bottom: 50px; right: 0; width: 215px; text-align: center;
            color: #fff; font-weight: 700; font-size: 55px; line-height: 1; z-index: 40; white-space: nowrap;
        }
    </style>
</head>
<body>

    <div class="panel">
        <h1>üõ†Ô∏è Generador Carrefour: Repair Station</h1>
        
        <div class="grid-2">
            <div>
                <label>1. Archivo CSV</label>
                <input type="file" id="csv-file" accept=".csv">
            </div>
            <div>
                <label>2. Codificaci√≥n del Excel</label>
                <select id="encoding-select">
                    <option value="ISO-8859-1" selected>Excel Cl√°sico / Espa√±ol (Windows-1252)</option>
                    <option value="UTF-8">UTF-8 (Moderno)</option>
                </select>
            </div>
        </div>

        <button id="btn-process" class="btn-main" onclick="startBatch()">üöÄ PROCESAR IM√ÅGENES</button>
        
        <div style="margin-top: 10px; font-size: 0.9em; color: #aaa;">
            LOG DEL SISTEMA:
        </div>
        <div class="console" id="console-log">Esperando archivo...</div>
    </div>

    <div id="shadow-factory">
        <div class="canvas-container" id="capture-area">
            <div id="bg-layer" class="bg-layer"></div>
            <img id="layer-footer" class="layer-png" src="footer_full.png">
            <img id="layer-badge" class="layer-png" src="badge_vaca.png">
            <div class="title-pill">
                <span id="txt-title">TITULO</span>
            </div>
            <div id="txt-weight">1 KG</div>
        </div>
    </div>

    <script>
        const logArea = document.getElementById('console-log');
        function log(msg) {
            logArea.innerHTML += `> ${msg}<br>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // --- 1. L√ìGICA DE DETECCI√ìN INTELIGENTE DE √çCONO ---
        function getBadgeFile(row) {
            // Unimos categor√≠a y nombre para buscar palabras clave
            const textToSearch = ((row.categoria || '') + ' ' + (row.nombre_producto || '')).toLowerCase();

            // Prioridad CERDO (Arregla lo del Jam√≥n)
            if (textToSearch.includes('cerdo') || 
                textToSearch.includes('puerco') || 
                textToSearch.includes('jamon') || 
                textToSearch.includes('jam√≥n') || 
                textToSearch.includes('fiambre') ||
                textToSearch.includes('bondiola') ||
                textToSearch.includes('panceta') ||
                textToSearch.includes('pechito')) {
                return 'badge_cerdo.png';
            }

            // POLLO
            if (textToSearch.includes('pollo') || 
                textToSearch.includes('ave') || 
                textToSearch.includes('patitas') || 
                textToSearch.includes('suprema') ||
                textToSearch.includes('granja')) {
                return 'badge_pollo.png';
            }

            // PESCADO
            if (textToSearch.includes('pescado') || 
                textToSearch.includes('mar') || 
                textToSearch.includes('filet') || 
                textToSearch.includes('merluza') ||
                textToSearch.includes('calamar')) {
                return 'badge_pescado.png';
            }

            // DEFAULT: VACA (Cualquier otra carne roja)
            return 'badge_vaca.png';
        }

        // --- 2. L√ìGICA DE FOOTER ---
        function getFooterFile(cooking) {
            const c = (cooking || '').toLowerCase();
            const hasParrilla = c.includes('parrilla');
            const hasHorno = c.includes('horno');
            const hasOlla = c.includes('olla');

            if (hasParrilla && hasHorno && hasOlla) return 'footer_full.png';
            if (hasParrilla && hasHorno) return 'footer_parrilla_horno.png';
            if (hasParrilla && hasOlla) return 'footer_parrilla_olla.png';
            if (hasHorno && hasOlla) return 'footer_horno_olla.png';
            if (hasParrilla) return 'footer_parrilla.png';
            if (hasHorno) return 'footer_horno.png';
            if (hasOlla) return 'footer_olla.png';
            return 'footer_full.png';
        }

        // --- 3. AUTO-AJUSTE DE TEXTO (Para que no se corte) ---
        function fitText() {
            const titleEl = document.getElementById('txt-title');
            const containerWidth = 750; // Espacio m√°ximo disponible aprox
            let fontSize = 50; // Tama√±o inicial
            
            // Reseteamos
            titleEl.style.fontSize = fontSize + 'px';
            
            // Reducimos mientras sea m√°s ancho que el contenedor
            while (titleEl.offsetWidth > containerWidth && fontSize > 20) {
                fontSize -= 2;
                titleEl.style.fontSize = fontSize + 'px';
            }
        }

        // --- 4. NORMALIZADOR DE COLUMNAS (Para que encuentre "Unidad") ---
        function normalizeRowKeys(row) {
            const newRow = {};
            Object.keys(row).forEach(key => {
                // Quitamos espacios, pasamos a min√∫sculas y quitamos acentos del header
                const cleanKey = key.trim().toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, ""); 
                newRow[cleanKey] = row[key];
            });
            return newRow;
        }

        // --- 5. SETUP DEL LIENZO ---
        function setupCanvas(rawRow) {
            return new Promise((resolve, reject) => {
                // Normalizamos las columnas (Unidad -> unidad, Peso -> unidad)
                const row = normalizeRowKeys(rawRow);

                // Mapeo flexible de la columna peso/unidad
                // Busca 'unidad', 'peso', 'contenido', 'cantidad'
                const unitValue = row.unidad || row.peso || row.contenido || row.cantidad || '';
                
                if (!unitValue) {
                    console.warn("Fila sin unidad detectada:", row);
                }

                // Asignar textos
                const titleEl = document.getElementById('txt-title');
                titleEl.innerText = (row.nombre_producto || row.producto || 'SIN NOMBRE').trim();
                document.getElementById('txt-weight').innerText = unitValue.trim();

                // Ejecutar ajuste de tama√±o de fuente
                fitText();

                // Asignar im√°genes
                document.getElementById('layer-badge').src = getBadgeFile(row); // Pasamos toda la fila
                document.getElementById('layer-footer').src = getFooterFile(row.coccion);

                // Fondo
                const imgUrl = row.imagen_url || row.imagen || row.foto || '';
                const bgLayer = document.getElementById('bg-layer');
                bgLayer.style.backgroundImage = 'none';
                
                if (!imgUrl) { resolve(); return; }

                const tempImg = new Image();
                tempImg.crossOrigin = "Anonymous"; 
                tempImg.onload = () => {
                    bgLayer.style.backgroundImage = `url('${imgUrl}')`;
                    resolve();
                };
                tempImg.onerror = () => {
                    log(`‚ö†Ô∏è Fall√≥ imagen: ${imgUrl}`);
                    bgLayer.style.backgroundColor = '#444';
                    resolve();
                };
                tempImg.src = imgUrl + (imgUrl.includes('?') ? '&' : '?') + 'cb=' + new Date().getTime();
            });
        }

        // --- 6. CAPTURA ---
        function generateImage() {
            const area = document.getElementById('capture-area');
            return new Promise((resolve, reject) => {
                html2canvas(area, {
                    scale: 2, 
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: null,
                    logging: false,
                    onclone: (doc) => {
                        const el = doc.getElementById('capture-area');
                        el.style.fontFeatureSettings = '"liga" 0';
                        el.style.imageRendering = 'high-quality';
                    }
                }).then(canvas => {
                    canvas.toBlob(blob => resolve(blob), 'image/webp', 0.95);
                }).catch(reject);
            });
        }

        // --- MOTOR PRINCIPAL ---
        async function startBatch() {
            const fileInput = document.getElementById('csv-file');
            const encoding = document.getElementById('encoding-select').value;
            
            if (!fileInput.files.length) { alert('Falta el CSV'); return; }

            const btn = document.getElementById('btn-process');
            btn.disabled = true; btn.innerText = '‚è≥ PROCESANDO...';
            logArea.innerHTML = '';

            Papa.parse(fileInput.files[0], {
                header: true,
                skipEmptyLines: true,
                encoding: encoding, // Usamos la selecci√≥n del usuario
                complete: async function(results) {
                    const rows = results.data;
                    
                    if(rows.length > 0) {
                        const firstRow = normalizeRowKeys(rows[0]);
                        log(`üîç Prueba de lectura: "${firstRow.nombre_producto || '??'}"`);
                        log(`üîç Peso detectado: "${firstRow.unidad || firstRow.peso || 'VAC√çO'}"`);
                    }

                    const zip = new JSZip();
                    const folder = zip.folder("Carrefour_Final_Fixed");

                    await document.fonts.ready;
                    
                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        // Validar si la fila tiene datos reales
                        if (!Object.values(row).some(x => x)) continue;

                        try {
                            // Normalizamos para obtener el nombre correcto para el log
                            const nRow = normalizeRowKeys(row);
                            const pName = nRow.nombre_producto || 'Producto_' + i;
                            
                            log(`üì∏ Generando: ${pName}`);
                            
                            await setupCanvas(row); // Pasamos la fila cruda, setup normaliza dentro
                            await new Promise(r => setTimeout(r, 50)); 
                            const blob = await generateImage();
                            
                            const cleanName = pName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                            folder.file(`${cleanName}.webp`, blob); 

                        } catch (error) { log(`‚ùå Error: ${error.message}`); }
                    }

                    log('üì¶ Creando ZIP...');
                    const content = await zip.generateAsync({type:"blob"});
                    saveAs(content, "Ofertas_Carrefour_Final.zip");
                    
                    btn.disabled = false; btn.innerText = 'üöÄ PROCESAR IM√ÅGENES';
                    log('‚úÖ ¬°TERMINADO!');
                }
            });
        }
    </script>
</body>
</html>
