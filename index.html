<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador Carrefour MASTER HD</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* --- ESTILOS GENERALES DE LA INTERFAZ --- */
        :root { --azul-carrefour: #0B3A8F; }
        
        body { 
            font-family: 'Ubuntu', sans-serif; 
            background: #121212; /* Fondo oscuro pro */
            margin: 0; padding: 40px; 
            display: flex; flex-direction: column; align-items: center; 
            color: white; 
        }
        
        .panel-control { 
            background: #252525; padding: 40px; border-radius: 16px; 
            width: 100%; max-width: 700px; border: 1px solid #333; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        h1 { margin: 0 0 20px 0; border-bottom: 3px solid var(--azul-carrefour); padding-bottom: 15px; font-size: 24px;}
        p { color: #aaa; margin-bottom: 30px; line-height: 1.5; }
        
        .input-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 10px; color: #fff; letter-spacing: 0.5px; }
        
        input[type="file"] { 
            background: #111; padding: 20px; width: 100%; 
            border: 2px dashed #555; border-radius: 8px; color: #fff; box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input[type="file"]:hover { border-color: var(--azul-carrefour); }

        .btn-download {
            background: var(--azul-carrefour); color: white; font-size: 20px; width: 100%; 
            padding: 20px; border: none; border-radius: 10px; cursor: pointer; 
            margin-top: 20px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
            transition: all 0.2s ease;
        }
        .btn-download:hover { background: #154bb5; transform: translateY(-2px); }
        .btn-download:disabled { background: #444; opacity: 0.7; cursor: not-allowed; transform: none; }

        .console-log { 
            background: #000; color: #00ff00; font-family: 'Consolas', monospace; 
            padding: 20px; height: 250px; overflow-y: auto; margin-top: 30px; 
            border-radius: 8px; font-size: 13px; border: 1px solid #333;
        }

        /* --- F√ÅBRICA FANTASMA (SHADOW FACTORY) --- */
        /* Aqu√≠ ocurre la magia. Dimensiones 1000x1000 REALES fuera de pantalla */
        #shadow-factory {
            position: fixed; 
            top: 0; 
            left: -10000px; /* Muy lejos de la pantalla */
            width: 1000px; 
            height: 1000px;
            background-color: #ffffff; 
            z-index: -9999;
        }

        /* LIENZO DE RENDERIZADO HD */
        .canvas-container {
            position: relative; 
            width: 1000px; 
            height: 1000px; 
            overflow: hidden;
            /* Optimizaciones de renderizado de texto */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: geometricPrecision;
        }

        /* CAPA 1: FONDO DIN√ÅMICO */
        .bg-layer {
            position: absolute; top: 0; left: 0; width: 1000px; height: 1000px;
            background-size: cover; background-position: center; background-repeat: no-repeat;
            z-index: 1;
        }

        /* CAPAS GR√ÅFICAS (PNGs) */
        .layer-png { position: absolute; pointer-events: none; }
        
        #layer-footer { 
            width: 1000px; height: 167px; 
            bottom: 0; left: 0; z-index: 10; 
            /* Evita blur en bordes */
            image-rendering: -webkit-optimize-contrast;
        }
        
        #layer-badge { 
            width: 187px; height: 155px; 
            top: 30px; left: 30px; z-index: 30; 
        }

        /* --- SOLUCI√ìN DEL TEXTO (FLEXBOX) --- */
        /* Esta es la clave para que se vea bien y no deformado */
        .title-container {
            position: absolute;
            top: 70px; 
            left: 180px; /* Se mete debajo del badge un poco */
            z-index: 20; /* Encima del fondo, debajo del badge */
            
            /* FLEXBOX M√ÅGICO: La caja crece con el texto */
            display: inline-flex;
            align-items: center;
            justify-content: flex-start;
            
            height: 75px; /* Altura fija de la pastilla */
            min-width: 100px; /* Ancho m√≠nimo */
            
            background: rgba(255,255,255, 0.95); /* Blanco casi puro */
            border-radius: 0 50px 50px 0; /* Redondeado solo a la derecha */
            
            /* PADDING: Empuja el texto visualmente */
            padding-left: 60px; /* Espacio para no chocar con el badge */
            padding-right: 40px; /* Aire al final */
            
            /* Cero bordes, cero sombras raras */
            box-shadow: none;
            border: none;
        }

        #txt-title {
            color: var(--azul-carrefour); 
            font-family: 'Ubuntu', sans-serif;
            font-weight: 700;
            font-size: 50px; 
            line-height: 1;
            white-space: nowrap; /* Obligatorio: Texto en una sola l√≠nea */
            margin: 0;
            padding-bottom: 6px; /* Ajuste √≥ptico vertical */
        }

        /* --- PESO / UNIDAD --- */
        #txt-weight {
            position: absolute; 
            bottom: 50px; 
            right: 0; 
            width: 215px; /* Coincide con el bloque azul del footer */
            text-align: center; 
            
            color: #FFFFFF;
            font-family: 'Ubuntu', sans-serif; 
            font-weight: 700; 
            font-size: 55px; 
            line-height: 1; 
            z-index: 40; 
            white-space: nowrap;
        }

    </style>
</head>
<body>

    <div class="panel-control">
        <h1>üè≠ Generador Masivo Carrefour (HD)</h1>
        <p>
            Modo: <b>Producci√≥n 1000x1000px</b><br>
            Formato: <b>WebP (Optimizado)</b><br>
            Columnas CSV: <i>nombre_producto, categoria, imagen_url, coccion, unidad</i>
        </p>
        
        <div class="input-group">
            <label>1. Subir Archivo CSV</label>
            <input type="file" id="csv-file" accept=".csv">
        </div>

        <button id="btn-process" class="btn-download" onclick="startBatch()">üöÄ PROCESAR Y DESCARGAR ZIP</button>

        <div class="console-log" id="console-log">Sistema listo. Esperando archivo...</div>
    </div>

    <div id="shadow-factory">
        <div class="canvas-container" id="capture-area">
            
            <div id="bg-layer" class="bg-layer"></div>
            
            <img id="layer-footer" class="layer-png" src="footer_full.png">
            
            <img id="layer-badge" class="layer-png" src="badge_vaca.png">
            
            <div class="title-container">
                <span id="txt-title">CARGANDO...</span>
            </div>
            
            <div id="txt-weight">1.5 kg</div>
            
        </div>
    </div>

    <script>
        const logArea = document.getElementById('console-log');
        
        // Funci√≥n de Log con Timestamp
        function log(msg) {
            const time = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${time}] ${msg}<br>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // --- L√ìGICA DE ASSETS (Mapeo de archivos) ---
        function getBadgeFile(category) {
            const cat = (category || '').toLowerCase();
            // L√≥gica de detecci√≥n difusa para evitar errores de tipeo
            if (cat.includes('vaca') || cat.includes('novillo') || cat.includes('carne') || cat.includes('bovino') || cat.includes('ternera')) return 'badge_vaca.png';
            if (cat.includes('cerdo') || cat.includes('puerco') || cat.includes('bondiola') || cat.includes('pechito') || cat.includes('matambre')) return 'badge_cerdo.png';
            if (cat.includes('pollo') || cat.includes('ave') || cat.includes('patitas') || cat.includes('suprema')) return 'badge_pollo.png';
            if (cat.includes('pescado') || cat.includes('mar') || cat.includes('filet') || cat.includes('merluza')) return 'badge_pescado.png';
            return 'badge_vaca.png'; // Default seguro
        }

        function getFooterFile(cooking) {
            const c = (cooking || '').toLowerCase();
            const hasParrilla = c.includes('parrilla');
            const hasHorno = c.includes('horno');
            const hasOlla = c.includes('olla');

            // Combinaciones (Prioridad Alta)
            if (hasParrilla && hasHorno && hasOlla) return 'footer_full.png';
            if (hasParrilla && hasHorno) return 'footer_parrilla_horno.png';
            if (hasParrilla && hasOlla) return 'footer_parrilla_olla.png';
            if (hasHorno && hasOlla) return 'footer_horno_olla.png';
            
            // Simples (Prioridad Baja)
            if (hasParrilla) return 'footer_parrilla.png';
            if (hasHorno) return 'footer_horno.png';
            if (hasOlla) return 'footer_olla.png';
            
            return 'footer_full.png'; // Default completo
        }

        // --- PREPARACI√ìN DEL LIENZO (SETUP) ---
        function setupCanvas(row) {
            return new Promise((resolve, reject) => {
                // 1. Asignar Textos
                const titleEl = document.getElementById('txt-title');
                const weightEl = document.getElementById('txt-weight');
                
                // Limpieza de datos
                titleEl.innerText = (row.nombre_producto || 'PRODUCTO').trim();
                weightEl.innerText = (row.unidad || '').trim();

                // 2. Asignar PNGs
                document.getElementById('layer-badge').src = getBadgeFile(row.categoria);
                document.getElementById('layer-footer').src = getFooterFile(row.coccion);

                // 3. Cargar Fondo (Manejo robusto de errores)
                const imgUrl = row.imagen_url;
                const bgLayer = document.getElementById('bg-layer');
                
                // Reiniciar fondo para evitar parpadeos de la imagen anterior
                bgLayer.style.backgroundImage = 'none';
                bgLayer.style.backgroundColor = '#f0f0f0'; // Fondo gris mientras carga

                if (!imgUrl) {
                    log(`‚ö†Ô∏è Fila sin URL de imagen. Usando gris.`);
                    resolve();
                    return;
                }

                const tempImg = new Image();
                tempImg.crossOrigin = "Anonymous"; // CR√çTICO PARA VTEX/WEB
                
                tempImg.onload = () => {
                    bgLayer.style.backgroundImage = `url('${imgUrl}')`;
                    resolve();
                };
                
                tempImg.onerror = () => {
                    log(`‚ö†Ô∏è Error cargando imagen remota: ${imgUrl}`);
                    // Intentamos seguir igual, saldr√° fondo gris
                    resolve();
                };

                // Truco anti-cach√© para forzar recarga de imagen
                const cacheBuster = imgUrl.includes('?') ? '&cb=' : '?cb=';
                tempImg.src = imgUrl + cacheBuster + new Date().getTime();
            });
        }

        // --- CAPTURA DE IMAGEN (HTML2CANVAS) ---
        function generateImage() {
            const area = document.getElementById('capture-area');

            return new Promise((resolve, reject) => {
                // Configuraci√≥n de renderizado "High Quality"
                html2canvas(area, {
                    scale: 1,            // 1:1 Pixel Perfect (porque el div ya mide 1000px)
                    width: 1000,
                    height: 1000,
                    useCORS: true,       // Permite im√°genes cross-origin
                    allowTaint: true,    // Permite canvas sucio
                    backgroundColor: null, // Transparencia real
                    logging: false,      // Limpiar consola
                    imageTimeout: 10000, // Esperar hasta 10s por im√°genes lentas
                    onclone: (clonedDoc) => {
                        // Fix para fuentes web y kerning
                        const clonedArea = clonedDoc.getElementById('capture-area');
                        clonedArea.style.fontFeatureSettings = '"liga" 0';
                        clonedArea.style.transform = 'translateZ(0)'; // Forzar GPU
                    }
                }).then(canvas => {
                    // Exportar a WebP calidad 92% (Mejor que JPG)
                    canvas.toBlob((blob) => {
                        if(blob) resolve(blob);
                        else reject(new Error("Canvas generado vac√≠o"));
                    }, 'image/webp', 0.92);
                }).catch(err => reject(err));
            });
        }

        // --- PROCESO POR LOTES (BATCH) ---
        async function startBatch() {
            const fileInput = document.getElementById('csv-file');
            if (!fileInput.files.length) { 
                alert('‚ö†Ô∏è Por favor selecciona un archivo CSV primero.'); 
                return; 
            }

            const btn = document.getElementById('btn-process');
            
            // Bloquear bot√≥n
            btn.disabled = true;
            btn.innerText = '‚è≥ INICIANDO MOTOR GR√ÅFICO...';
            logArea.innerHTML = ''; // Limpiar log anterior

            // Parsear CSV
            Papa.parse(fileInput.files[0], {
                header: true,
                skipEmptyLines: true,
                encoding: "UTF-8", // Asegurar acentos
                complete: async function(results) {
                    const rows = results.data;
                    const total = rows.length;
                    
                    if (total === 0) {
                        log('‚ùå El CSV est√° vac√≠o o mal formateado.');
                        btn.disabled = false;
                        return;
                    }

                    log(`‚úÖ CSV Cargado. ${total} productos detectados.`);
                    log(`üì¶ Preparando ZIP...`);
                    
                    const zip = new JSZip();
                    const folder = zip.folder("Ofertas_Carrefour_HD");

                    // Asegurar que la fuente Ubuntu est√© cargada antes de empezar
                    log('‚è≥ Verificando tipograf√≠as...');
                    await document.fonts.ready;
                    
                    // Bucle Principal
                    for (let i = 0; i < total; i++) {
                        const row = rows[i];
                        
                        // Validar fila m√≠nima
                        if (!row.nombre_producto) continue;

                        log(`üîÑ Procesando [${i+1}/${total}]: ${row.nombre_producto}`);
                        
                        try {
                            // 1. Montar la escena
                            await setupCanvas(row);
                            
                            // 2. Peque√±a pausa t√©cnica (50ms) para que el navegador renderice el DOM
                            // Esto evita glitches visuales si la CPU va muy r√°pido
                            await new Promise(r => setTimeout(r, 50));

                            // 3. Tomar la foto
                            const blob = await generateImage();
                            
                            // 4. Guardar en memoria ZIP
                            const cleanName = row.nombre_producto
                                .replace(/[^a-z0-9]/gi, '_') // Quitar caracteres raros
                                .toLowerCase();
                            
                            folder.file(`${cleanName}.webp`, blob);

                        } catch (error) {
                            log(`‚ùå ERROR en ${row.nombre_producto}: ${error.message}`);
                        }
                    }

                    // Finalizaci√≥n
                    log('üì¶ Empaquetando y comprimiendo ZIP...');
                    const content = await zip.generateAsync({type:"blob"});
                    
                    saveAs(content, "Carrefour_Ofertas_Lote.zip");
                    
                    log('‚ú® ¬°PROCESO TERMINADO! Descarga iniciada.');
                    btn.disabled = false;
                    btn.innerText = 'üöÄ PROCESAR Y DESCARGAR ZIP';
                }
            });
        }
    </script>
</body>
</html>
